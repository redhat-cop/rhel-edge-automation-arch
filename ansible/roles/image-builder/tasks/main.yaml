- name: Query IngressController
  community.kubernetes.k8s_info:
    api_key: "{{ lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/token') }}"
    api_version: operator.openshift.io/v1
    ca_cert: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    host: https://kubernetes.default.svc
    kind: IngressController
    name: "{{ ingress_controller_name }}"
    namespace: "{{ ingress_operator_namespace }}"
    validate_certs: yes
  become: no
  delegate_to: localhost
  register: ingress_controller

- name: Set Certificate Secret Name
  ansible.builtin.set_fact:
    ingress_controller_tls_secret_name: "{{ ingress_controller.resources[0].spec.defaultCertificate.name }}"

- name: Query Ingress TLS Secret
  community.kubernetes.k8s_info:
    api_key: "{{ lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/token') }}"
    api_version: v1
    ca_cert: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    host: https://kubernetes.default.svc
    kind: Secret
    name: "{{ ingress_controller_tls_secret_name }}"
    namespace: "{{ ingress_controller_namespace }}"
    validate_certs: yes
  become: no
  delegate_to: localhost
  register: ingress_controller_tls_secret

- name: Set Ingress TLS Certificates
  ansible.builtin.set_fact:
    ingress_controller_certificates: |
      {{
        (ingress_controller_tls_secret.resources[0].data['tls.crt'] | b64decode).split('-----BEGIN CERTIFICATE-----') |
          reject('equalto', '') | list
      }}

- name: Parse Certificates
  community.crypto.x509_certificate_info:
    content: "-----BEGIN CERTIFICATE-----\n{{ item }}"
  loop: "{{ ingress_controller_certificates }}"
  register: x509_certificate_info

- name: Build List of CA Certificates
  ansible.builtin.set_fact:
    ingress_controller_ca_certificates: |
      {{
        x509_certificate_info.results | to_json | from_json |
          json_query("[?basic_constraints[?contains(@, 'CA:TRUE')]].item")
      }}

- name: Create CA Certificate Payload
  ansible.builtin.set_fact:
    ingress_controller_ca_certificate_payload: |
      {{
        (ingress_controller_ca_certificate_payload | default('')) + "-----BEGIN CERTIFICATE-----" + item
      }}
  loop: "{{ ingress_controller_ca_certificates }}"

- name: Copy Certificate Payload to Image Builder VM
  ansible.builtin.copy:
    content: "{{ ingress_controller_ca_certificate_payload }}"
    dest: "{{ trust_anchor_path }}/{{ trust_anchor_file }}"
    group: root
    mode: "0644"
    owner: root

- name: Update CA Trust
  ansible.builtin.command:
    cmd: update-ca-trust

- name: Register Host
  community.general.redhat_subscription:
    state: present
    username: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/username') }}"
    password: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/password') }}"
    pool_ids: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/pool_id') }}"

- name: Setup Repositories
  community.general.rhsm_repository:
    state: enabled
    purge: yes
    name:
      - rhel-8-for-x86_64-appstream-rpms
      - rhel-8-for-x86_64-baseos-rpms

- name: Install Packages
  ansible.builtin.dnf:
    state: latest
    name:
      - osbuild-composer
      - composer-cli
      - cockpit-composer
      - bash-completion
      - firewalld
      - genisoimage
      - httpd
      - syslinux

- name: Enable Cockpit/Composer/Firewalld/Apache
  ansible.builtin.systemd:
    state: started
    enabled: yes
    name: "{{ item }}"
  loop:
    - osbuild-composer.socket
    - cockpit.socket
    - httpd.service
    - firewalld

- name: Enable Firewall Ports for Cockpit/Composer/Apache
  ansible.posix.firewalld:
    permanent: yes
    immediate: yes
    service: "{{ item }}"
    state: enabled
  loop:
    - cockpit
    - http

- name: Manage Composer Sources
  ansible.builtin.include_tasks: composer-sources.yaml
