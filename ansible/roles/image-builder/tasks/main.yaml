- name: Query IngressController
  community.kubernetes.k8s_info:
    api_key: "{{ lookup('file', '/var/run/secrets/kubernetes.io/serviceaccount/token') }}"
    api_version: operator.openshift.io/v1
    ca_cert: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    host: https://kubernetes.default.svc
    kind: IngressController
    name: "{{ ingress_controller_name }}"
    namespace: "{{ ingress_controller_namespace }}"
    validate_certs: yes
  become: no
  delegate_to: localhost
  register: ingress_controller

- name: Set Certificate Secret Name
  ansible.builtin.set_fact:
    ingress_controller_secret: "{{ ingress_controller.resources[0].spec.defaultCertificate.name }}"

- name: Debug
  ansible.builtin.debug:
    var: ingress_controller

- name: Debug
  ansible.builtin.debug:
    var: ingress_controller_secret

- fail:
    msg: stop

- name: Register Host
  community.general.redhat_subscription:
    state: present
    username: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/username') }}"
    password: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/password') }}"
    pool_ids: "{{ lookup('file', '/var/secrets/redhat-portal-credentials/pool_id') }}"

- name: Setup Repositories
  community.general.rhsm_repository:
    state: enabled
    purge: yes
    name:
      - rhel-8-for-x86_64-appstream-rpms
      - rhel-8-for-x86_64-baseos-rpms

- name: Install Packages
  ansible.builtin.dnf:
    state: latest
    name:
      - osbuild-composer
      - composer-cli
      - cockpit-composer
      - bash-completion
      - firewalld
      - genisoimage
      - httpd
      - syslinux

- name: Enable Cockpit/Composer/Firewalld/Apache
  ansible.builtin.systemd:
    state: started
    enabled: yes
    name: "{{ item }}"
  loop:
    - osbuild-composer.socket
    - cockpit.socket
    - httpd.service
    - firewalld

- name: Enable Firewall Ports for Cockpit/Composer/Apache
  ansible.posix.firewalld:
    permanent: yes
    immediate: yes
    service: "{{ item }}"
    state: enabled
  loop:
    - cockpit
    - http

- name: Manage Composer Sources
  ansible.builtin.include_tasks: composer-sources.yaml
